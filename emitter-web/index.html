<!DOCTYPE html>
<html>
<head></head>
<body>
<textArea id="source">
ls
</textArea>
<select name="language-select" id="language-select">
  <option value="sh">Shell</option>
  <option value="c">C</option>
  <option value="cpp">CPP</option>
  <option value="java">Java</option>
  <option value="python">Python</option>
  <option value="ruby">Ruby</option>
</select>

<button onclick="connect(); output.innerText=''">compile</button>

<pre id="output" ></pre>

<script>

const output = document.querySelector("#output") ; 
const language_select = document.querySelector('#language-select') ; 

const old = console.log.bind(console) ;
const olderror = console.error.bind(console) ;

console.log = (item) => {
  output.innerText += item + '\n' ;
}

console.error = (item) => {
  output.innerText += item + '\n' ;
}

const connect = async () => {
   const sourceCode = document.querySelector('#source').value ;

   const ws = new WebSocket(`ws://localhost:8080`);

   ws.onerror = (e) =>{
      console.error(e.message) ;
   };

   ws.onopen = () => {
     console.log('connected') ;
   };

   ws.onmessage = async (event) => {
     const data = event.data ; 
     const json = JSON.parse(data) ;
     switch(json.command){
       //server requests identification
       case 'identify': console.log('server requesting identification') ;
                        await ws.send(JSON.stringify({command:'identify', type:'emitter'})); 
                        console.log('sending identification to server') ;
                        break;
       //server validated identification and awaits a job order
       case 'proceed':  console.log('identification succeeded') ;
                        console.log('sending code for compilation') ;
                        await ws.send(JSON.stringify({command: 'compile', source: sourceCode, language: language_select.value }));
                        console.log('source code sent: ' + sourceCode) ;
                        break;
       //server returns the output of the sourceCode execution
       case 'compile':  const {stdout, stderr} = json ;
                        console.log('stdout: ' + stdout) ;
                        console.log('stderr: ' + stderr) ;
                        console.error = olderror; 
                        break;
     }
   };

   ws.onclose = (event) => {
      console.log('connection closed');
   };
}

</script>
</body>
</html>
